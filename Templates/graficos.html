<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Estilos anteriores mantidos */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: #102770;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .voltar-btn {
            text-decoration: none;
            color: #fff;
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }

        .voltar-btn:hover {
            background-color: #4BC0C0;
            color: #fff;
        }

        .voltar-btn i {
            margin-right: 0.5rem;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            color: #0A58CAFF;
            margin-top: 100px;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            max-width: 1200px;
            margin: 30px auto;
            padding-top: 80px;
        }

        .chart-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0px 6px 18px rgba(0, 0, 0, 0.1);
            width: 680px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            transition-delay: 0.2s;
        }

        .chart-container h2 {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: #0A58CAFF;
        }

        .chart-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .no-data {
            font-size: 1.2rem;
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }

        .filtros {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .filtros label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .filtros input {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .filtros button {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            background-color: #0A58CAFF;
            color: white;
            cursor: pointer;
        }

        .filtros button:hover {
            background-color: #4BC0C0;
        }

        /* Estilo para o container do gr치fico 3 e 4 */
        .grafico-chaves-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        #tempoUsoChart{
            width: 900px;
        }
        #chart4{
            width: 900px;
        }

        .lista-chaves {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0px 6px 18px rgba(0, 0, 0, 0.1);
            width: 400px;
        }

        .lista-chaves h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #0A58CAFF;
        }

        .lista-chaves ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .lista-chaves li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .lista-chaves .cor {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <!-- Header com Bot칚o de Voltar -->
    <div class="header">
        <a href="{{ url_for('telaInicialGerente') if session['user_type'] == 'gerente' else (url_for('telaInicialProfessor') if session['user_type'] == 'professor' else url_for('telaInicialAluno')) }}" class="voltar-btn">
            <i class="bi bi-arrow-left-circle"></i>
        </a>
    </div>

    <h1>Dashboard de Dados</h1>

    <!-- Gr치ficos -->
    <div class="dashboard">
        <div class="chart-container" id="chart1">
            <h2>Status das Chaves</h2>
            <div id="statusChavesChart"></div>
        </div>

        <div class="chart-container" id="chart2">
            <h2>Usu치rios por Categoria</h2>
            <div id="usuariosChart"></div>
        </div>

        <div class="chart-container" id="chart3">
            <h2>Chaves Mais Acessadas</h2>
            <!-- Filtros ao lado do gr치fico -->
            <div class="filtros">
                <label for="data_inicio">Data In칤cio:</label>
                <input type="date" id="data_inicio" name="data_inicio">
                <label for="data_fim">Data Fim:</label>
                <input type="date" id="data_fim" name="data_fim">
                <button onclick="carregarGraficos()">Filtrar</button>
            </div>
            <!-- Container para o gr치fico e a lista de chaves -->
            <div class="grafico-chaves-container">
                <div class="lista-chaves" id="listaChaves">
                    <h3>Chaves</h3>
                    <ul id="listaChavesUl"></ul>
                </div>
                <div id="chavesChart"></div>
            </div>
        </div>

        <div class="chart-container" id="chart4">
            <h2>Tempo de Uso das Chaves</h2>
            <!-- Container para o gr치fico e a lista de chaves -->
            <div class="grafico-chaves-container">
                <div class="lista-chaves" id="listaChavesTempoUso">
                    <h3>Chaves</h3>
                    <ul id="listaChavesTempoUsoUl"></ul>
                </div>
                <div id="tempoUsoChart"></div>
            </div>
        </div>
    </div>

    <script>
        // Vari치veis globais para armazenar as inst칙ncias dos gr치ficos
        let statusChavesChart;
        let usuariosChart;
        let chavesChart;
        let tempoUsoChart;

        async function carregarGraficos() {
            const data_inicio = document.getElementById('data_inicio').value;
            const data_fim = document.getElementById('data_fim').value;

            const url = new URL('http://127.0.0.1:5000/api/dados-graficos');
            if (data_inicio) url.searchParams.append('data_inicio', data_inicio);
            if (data_fim) url.searchParams.append('data_fim', data_fim);

            const resposta = await fetch(url);
            const dados = await resposta.json();
            console.log(dados);

            function mostrarComDelay(elemento, tempo) {
                setTimeout(() => {
                    elemento.classList.add("show");
                }, tempo);
            }

            // Paleta de cores moderna
            const cores = ['#36A2EB', '#4BC0C0', '#FF9F40', '#9966FF', '#FF6384'];

            // 游늷 Gr치fico 1: Status das Chaves
            if (statusChavesChart) {
                statusChavesChart.destroy(); // Destruir o gr치fico anterior
            }
            const statusChavesOptions = {
                series: [{
                    name: "Quantidade",
                    data: [dados.total_chaves, dados.chaves_guardadas, dados.chaves_em_uso]
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    animations: {
                        enabled: true,
                        easing: 'easeOutBounce',
                        speed: 1000
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 10,
                        horizontal: false,
                        distributed: true
                    }
                },
                colors: [cores[0], cores[1], cores[2]], // Cores diferentes para cada barra
                xaxis: {
                    categories: ['Total de Chaves', 'Chaves Guardadas', 'Chaves em Uso'],
                    labels: {
                        style: {
                            fontSize: '14px',
                            fontWeight: 600
                        }
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            fontSize: '14px',
                            fontWeight: 600
                        }
                    }
                },
                tooltip: {
                    theme: 'dark',
                    style: {
                        fontSize: '14px'
                    }
                }
            };
            statusChavesChart = new ApexCharts(document.querySelector("#statusChavesChart"), statusChavesOptions);
            statusChavesChart.render();

            mostrarComDelay(document.getElementById("chart1"), 200);

            // 游늷 Gr치fico 2: Usu치rios por Categoria
            if (usuariosChart) {
                usuariosChart.destroy(); // Destruir o gr치fico anterior
            }
            const usuariosOptions = {
                series: dados.usuarios.valores,
                chart: {
                    type: 'donut',
                    height: 300,
                    animations: {
                        enabled: true,
                        easing: 'easeOutQuart',
                        speed: 1200
                    }
                },
                labels: dados.usuarios.categorias,
                colors: cores,
                legend: {
                    position: 'bottom',
                    fontSize: '14px',
                    fontWeight: 600
                },
                tooltip: {
                    theme: 'dark',
                    style: {
                        fontSize: '14px'
                    }
                }
            };
            usuariosChart = new ApexCharts(document.querySelector("#usuariosChart"), usuariosOptions);
            usuariosChart.render();

            mostrarComDelay(document.getElementById("chart2"), 400);

            // 游늷 Gr치fico 3: Chaves Mais Acessadas
            if (chavesChart) {
                chavesChart.destroy(); // Destruir o gr치fico anterior
            }
            if (dados.chaves_acessadas && dados.chaves_acessadas.nome.length > 0) {
                const chavesOptions = {
                    series: [{
                        name: 'Acessos',
                        data: dados.chaves_acessadas.quantidades
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        animations: {
                            enabled: true,
                            easing: 'easeOutCubic',
                            speed: 1500
                        }
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 10,
                            horizontal: false,
                            distributed: true
                        }
                    },
                    colors: cores,
                    xaxis: {
                        labels: {
                            style: {
                                fontSize: '14px',
                                fontWeight: 600
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontSize: '14px',
                                fontWeight: 600
                            }
                        }
                    },
                    tooltip: {
                        theme: 'dark',
                        style: {
                            fontSize: '14px'
                        }
                    }
                };
                chavesChart = new ApexCharts(document.querySelector("#chavesChart"), chavesOptions);
                chavesChart.render();

                // Atualizar a lista de chaves
                const listaChavesUl = document.getElementById("listaChavesUl");
                listaChavesUl.innerHTML = ""; // Limpar a lista anterior
                dados.chaves_acessadas.nome.forEach((nome, index) => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <div class="cor" style="background-color: ${cores[index % cores.length]};"></div>
                        <span>${nome}</span>
                    `;
                    listaChavesUl.appendChild(li);
                });
            } else {
                document.getElementById("chavesChart").innerHTML = "<div class='no-data'>Sem dados dispon칤veis</div>";
                document.getElementById("listaChavesUl").innerHTML = ""; // Limpar a lista
            }

            mostrarComDelay(document.getElementById("chart3"), 600);

            // 游늷 Gr치fico 4: Tempo de Uso das Chaves
            if (tempoUsoChart) {
                tempoUsoChart.destroy(); // Destruir o gr치fico anterior
            }
            if (dados.tempo_uso_chaves && dados.tempo_uso_chaves.chave.length > 0) {
                const tempoUsoOptions = {
                    series: [{
                        name: 'Tempo Fora (minutos)',
                        data: dados.tempo_uso_chaves.tempo_fora
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        animations: {
                            enabled: true,
                            easing: 'easeOutCubic',
                            speed: 1500
                        }
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 10,
                            horizontal: false,
                            distributed: true
                        }
                    },
                    colors: cores,
                    xaxis: {
                        labels: {
                            style: {
                                fontSize: '14px',
                                fontWeight: 600
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontSize: '14px',
                                fontWeight: 600
                            }
                        }
                    },
                    tooltip: {
                        theme: 'dark',
                        style: {
                            fontSize: '14px'
                        }
                    }
                };
                tempoUsoChart = new ApexCharts(document.querySelector("#tempoUsoChart"), tempoUsoOptions);
                tempoUsoChart.render();

                // Atualizar a lista de chaves
                const listaChavesTempoUsoUl = document.getElementById("listaChavesTempoUsoUl");
                listaChavesTempoUsoUl.innerHTML = ""; // Limpar a lista anterior
                dados.tempo_uso_chaves.chave.forEach((chave, index) => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <div class="cor" style="background-color: ${cores[index % cores.length]};"></div>
                        <span>${chave}</span>
                    `;
                    listaChavesTempoUsoUl.appendChild(li);
                });
            } else {
                document.getElementById("tempoUsoChart").innerHTML = "<div class='no-data'>Sem dados dispon칤veis</div>";
                document.getElementById("listaChavesTempoUsoUl").innerHTML = ""; // Limpar a lista
            }

            mostrarComDelay(document.getElementById("chart4"), 800);
        }

        // Carregar gr치ficos ao carregar a p치gina
        carregarGraficos();
    </script>

</body>
</html>